<%
  // รับค่าจาก server
  const _member  = member || null;
  const _borrows = Array.isArray(borrows) ? borrows : [];   // ใช้ borrows (ไม่ใช่ loans)
  const today    = new Date().toISOString().slice(0,10);
%>
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>การคืนอุปกรณ์</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Prompt',sans-serif;background:#F5F6FA;color:#111}
    .wrap{max-width:480px;margin:28px auto;background:#fff;border-radius:18px;box-shadow:0 10px 25px rgba(0,0,0,.08);padding:26px}
    h1{text-align:center;font-weight:600;margin:8px 0 18px}
    .card-inner{border:1px solid #e5e7eb;border-radius:16px;padding:18px;background:#fff;margin-bottom:14px}
    .label{font-size:.9rem;color:#6b7280;margin-bottom:6px}
    .form-control,.form-select{border-radius:12px;border:1px solid #e5e7eb;padding:.7rem .9rem}
    .btn-accent{background:#fbbf24;border:none;color:#111;border-radius:999px;padding:.7rem 1rem;font-weight:600;box-shadow:0 8px 18px rgba(251,191,36,.35)}
    .muted{color:#6b7280;font-size:.9rem}
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mt-3">การคืนอุปกรณ์</h1>
    <div class="wrap">

      <% if (typeof message === 'string' && message) { %>
        <div class="alert alert-warning">
          <%= message %> <a href="/staff-home" class="alert-link">กลับไปสแกนใหม่</a>
        </div>
      <% } %>

      <div class="text-center mb-3">
        <div class="muted">สมาชิก</div>
        <div class="fw-semibold"><%= _member ? _member.full_name : '-' %></div>
      </div>

      <% if (!_borrows.length) { %>
        <div class="alert alert-info text-center">ไม่มีรายการคงค้าง</div>
      <% } %>

      <% _borrows.forEach(item => { 
           const outstanding = Number(item.qty || 0);  // คงค้าง = qty ปัจจุบันของ tx
      %>
        <div class="card-inner">
          <!-- ✅ ชื่ออุปกรณ์ -->
          <div class="fw-semibold">อุปกรณ์: <%= item.item_name %></div>
          <div class="muted">ยืมเมื่อ: <%= new Date(item.borrow_date).toLocaleDateString() %></div>
          <div class="muted mb-2">คงค้าง: <%= outstanding %> ชิ้น</div>

          <form method="post" action="/return/submit" onsubmit="return validateQty(this)">
            <!-- ใช้ tx_id อ้างอิงรายการยืม -->
            <input type="hidden" name="tx_id" value="<%= item.tx_id %>">
            <input type="hidden" name="member_id" value="<%= _member ? _member.id : '' %>">

            <div class="mb-2">
              <label class="form-label">จำนวนที่จะคืน</label>
              <select name="return_qty" class="form-select" data-max="<%= outstanding %>" required>
                <% for (let n=1; n<=outstanding; n++) { %>
                  <option value="<%= n %>"><%= n %></option>
                <% } %>
              </select>
              <div class="form-text text-danger d-none">จำนวนเกินกว่าคงค้าง</div>
            </div>

            <div class="mb-2">
              <label class="form-label">วันที่คืน</label>
              <input type="date" name="return_date" class="form-control" value="<%= today %>" required>
            </div>

            <button class="btn btn-accent w-100" type="submit">ส่งคืน</button>
          </form>
        </div>
      <% }) %>

      <div class="text-center mt-3">
        <a class="btn btn-outline-secondary btn-sm" href="/staff-home">สแกนสมาชิกคนถัดไป</a>
      </div>
    </div>
  </div>

  <script>
    function validateQty(form){
      const sel  = form.querySelector('select[name="return_qty"]');
      const max  = parseInt(sel.dataset.max,10);
      const val  = parseInt(sel.value,10);
      const help = form.querySelector('.form-text');
      if (val > max) {
        help.classList.remove('d-none');
        return false;
      }
      help.classList.add('d-none');
      return true;
    }
  </script>
</body>
</html>
