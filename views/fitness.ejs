<!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏ü‡∏¥‡∏ï‡πÄ‡∏ô‡πá‡∏ïviews/fitness.ejs -->
<%
  // server ‡∏Ñ‡∏ß‡∏£‡∏™‡πà‡∏á { member } ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
  const m         = member || null;                   // { id, full_name, member_type:'student'|'external', email? }
  const isStudent = m?.member_type === 'student';
  const fee       = isStudent ? 5 : 30;
  const today     = new Date().toISOString().slice(0,10);
%>
<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏ü‡∏¥‡∏ï‡πÄ‡∏ô‡πá‡∏ï</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#16a34a;      /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏™‡∏î */
      --ink:#111827;
      --muted:#6b7280;
      --card:#ffffff;
      --bg:#f5f7fb;
      --ring:#e5e7eb;
      --accent:#fbbf24;
    }
    *{box-sizing:border-box}
    body{font-family:'Prompt',sans-serif;background:var(--bg);color:var(--ink)}
    .container-max{max-width:1100px}
    .page-title{font-weight:700;font-size:clamp(1.25rem,2vw,1.6rem)}
    .grid{display:grid;grid-template-columns:1fr;gap:22px}
    @media(min-width:992px){.grid{grid-template-columns:1.05fr .95fr}}
    .cardx{background:var(--card);border-radius:18px;padding:22px;box-shadow:0 12px 30px rgba(0,0,0,.07);border:1px solid var(--ring)}
    .subtle{color:var(--muted)}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:.32rem .7rem;border-radius:999px;background:#ecfdf5;color:#065f46;font-weight:600;border:1px solid #d1fae5}
    .avatar{width:112px;height:112px;border-radius:16px;background:linear-gradient(180deg,#fff,#f8fafc);border:1px solid var(--ring);display:flex;align-items:center;justify-content:center;box-shadow:0 8px 18px rgba(0,0,0,.05)}
    .avatar svg{width:58px;height:58px;color:#94a3b8}
    .btn-brand{background:var(--brand);border:none;font-weight:700}
    .btn-brand:hover{filter:brightness(.98)}
    .btn-accent{background:var(--accent);border:none;color:#111;border-radius:999px;font-weight:700}
    .field{border-radius:12px;border:1px solid var(--ring);padding:.7rem .9rem}
    .divider{height:1px;background:var(--ring);margin:12px 0}
    .kpi{display:flex;gap:14px}
    .kpi .item{flex:1;border:1px dashed var(--ring);border-radius:12px;padding:10px 12px;background:#fafafa}
    .kpi .item b{font-size:1.05rem}
    .receipt{border-radius:14px;border:1px dashed var(--ring);background:#fcfdfd;padding:12px}
    .receipt .row{display:flex;justify-content:space-between;margin:.15rem 0}
    .link{color:#2563eb;text-decoration:none}
    .link:hover{text-decoration:underline}
    .floating{position:fixed;inset:auto 16px 16px auto;z-index:30}
  </style>
</head>
<body>
  <div class="container container-max py-3 py-lg-4">
    <!-- header -->
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div class="d-flex align-items-center gap-3">
        <h1 class="page-title mb-0">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏ü‡∏¥‡∏ï‡πÄ‡∏ô‡πá‡∏ï</h1>
        <% if (m) { %>
          <span class="chip"><span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span> <strong><%= isStudent ? '‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤' : '‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å' %></strong></span>
        <% } %>
      </div>
      <a class="link" href="/staff-home">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</a>
    </div>

    <!-- ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πÅ‡∏Å‡∏ô -->
    <% if (!m) { %>
      <div class="cardx text-center">
        <div class="mb-3"><span class="chip">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span></div>
        <p class="subtle mb-1">‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î ‚Äú‡∏ü‡∏¥‡∏ï‡πÄ‡∏ô‡∏™‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</p>
        <p class="subtle">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ö‡∏ô HTTPS (‡πÄ‡∏ä‡πà‡∏ô ngrok)</p>
        <div class="mt-2"><a href="/staff-home" class="btn btn-brand">‡πÑ‡∏õ‡∏™‡πÅ‡∏Å‡∏ô QR</a></div>
      </div>
    <% } %>

    <% if (m) { %>
    <div class="grid">
      <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å + KPI + ‡∏™‡∏•‡∏¥‡∏õ‡∏¢‡πà‡∏≠ -->
      <div class="cardx">
        <div class="d-flex align-items-center gap-3">
          <div class="avatar">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.4"
                d="M15.75 7.5a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.5 19.5a7.5 7.5 0 0 1 15 0"/>
            </svg>
          </div>
          <div>
            <div class="subtle">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
            <div class="fw-semibold fs-5"><%= m.full_name %></div>
            <div class="subtle small"><%= m.email || '-' %></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="kpi">
          <div class="item">
            <div class="subtle small">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</div>
            <b><%= isStudent ? '‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤' : '‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å' %></b>
          </div>
          <div class="item">
            <div class="subtle small">‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>
            <b><%= fee %> ‡∏ø</b>
          </div>
          <div class="item">
            <div class="subtle small">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
            <b><%= today %></b>
          </div>
        </div>

        <div class="divider"></div>

        <div class="receipt" id="rcp">
          <div class="subtle mb-1">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏•‡∏¥‡∏õ‡∏¢‡πà‡∏≠</div>
          <div class="row"><span>‡∏ä‡∏∑‡πà‡∏≠</span> <b><%= m.full_name %></b></div>
          <div class="row"><span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ</span> <b id="rcp-date"><%= today %></b></div>
          <div class="row"><span>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</span> <b id="rcp-pay">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</b></div>
          <div class="row"><span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</span> <b id="rcp-amt"><%= fee %> ‡∏ø</b></div>
        </div>
      </div>

      <!-- ‡∏Ç‡∏ß‡∏≤: ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
      <div class="cardx">
        <form method="post" action="/fitness/submit" id="fitForm" class="needs-validation" novalidate>
          <input type="hidden" name="member_id"   value="<%= m.id %>">
          <input type="hidden" name="member_type" value="<%= isStudent ? 'student' : 'external' %>">

          <div class="mb-3">
            <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ</label>
            <input type="date" name="visit_date" class="form-control field" value="<%= today %>" required>
            <div class="invalid-feedback">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ</div>
          </div>

          <div class="mb-3">
            <label class="form-label">‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ (‡∏ö‡∏≤‡∏ó)</label>
            <input type="number" name="amount" class="form-control field" value="<%= fee %>" min="0" step="1" required>
            <div class="form-text subtle"><%= isStudent ? '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 5 ‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏£‡∏±‡πâ‡∏á' : '‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å 30 ‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏£‡∏±‡πâ‡∏á' %></div>
          </div>

          <div class="mb-3">
            <label class="form-label d-block">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
            <div class="d-flex gap-3">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="pay_method" id="cash" value="cash" checked>
                <label class="form-check-label" for="cash">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="pay_method" id="qr" value="qr">
                <label class="form-check-label" for="qr">‡∏™‡πÅ‡∏Å‡∏ô QR</label>
              </div>
            </div>
          </div>

          <button class="btn btn-accent w-100 py-2" type="submit" id="btnSubmit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ</button>
          <div class="subtle text-center mt-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏û‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</div>
        </form>
      </div>
    </div>
    <% } %>
  </div>

  <!-- toast ‡πÅ‡∏à‡πâ‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≤‡∏Å‡∏ù‡∏±‡πà‡∏á server ‡∏ú‡πà‡∏≤‡∏ô query ?ok=fitness ‡∏Å‡πá‡πÑ‡∏î‡πâ) -->
  <% if (typeof ok !== 'undefined' && ok === 'fitness') { %>
  <div class="floating alert alert-success shadow">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏ü‡∏¥‡∏ï‡πÄ‡∏ô‡πá‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ üéâ</div>
  <% } %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏•‡∏¥‡∏õ‡∏¢‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
    const form = document.getElementById('fitForm');
    const dateEl = form?.querySelector('input[name="visit_date"]');
    const amtEl  = form?.querySelector('input[name="amount"]');
    const payEls = form?.querySelectorAll('input[name="pay_method"]');

    function updateReceipt(){
      if (dateEl) document.getElementById('rcp-date').textContent = dateEl.value || '-';
      if (amtEl)  document.getElementById('rcp-amt').textContent  = (amtEl.value || 0) + ' ‡∏ø';
      if (payEls){
        const v = [...payEls].find(r=>r.checked)?.value === 'qr' ? '‡∏™‡πÅ‡∏Å‡∏ô QR' : '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î';
        document.getElementById('rcp-pay').textContent = v;
      }
    }
    dateEl?.addEventListener('input', updateReceipt);
    amtEl?.addEventListener('input', updateReceipt);
    payEls?.forEach(r=>r.addEventListener('change', updateReceipt));
    updateReceipt();

    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥ + ‡∏ï‡∏£‡∏ß‡∏à‡∏ü‡∏≠‡∏£‡πå‡∏°
    form?.addEventListener('submit', (e)=>{
      if (!form.checkValidity()){
        e.preventDefault(); e.stopPropagation();
        form.classList.add('was-validated');
        return;
      }
      const btn = document.getElementById('btnSubmit');
      btn.disabled = true;
      btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
    });
  </script>
</body>
</html>
