<!--รายการอุปกรณ์-->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>รายการอุปกรณ์ | เจ้าหน้าที่</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Prompt',sans-serif;background:#f3f4f6}
    .wrap{max-width:900px;margin:28px auto;background:#fff;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.08);padding:22px}
    .actions form, .actions button{margin-left:.25rem}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="m-0">รายการอุปกรณ์</h3>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" href="/staff-home">หน้าเจ้าหน้าที่</a>
        <a class="btn btn-primary" href="/staff/inventory/new">+ เพิ่มอุปกรณ์</a>
      </div>
    </div>

    <% if (success === 'updated') { %>
      <div class="alert alert-success">อัปเดตข้อมูลเรียบร้อย</div>
    <% } else if (success === 'deleted') { %>
      <div class="alert alert-success">ลบอุปกรณ์แล้ว</div>
    <% } else if (success === 'dup') { %>
      <div class="alert alert-warning">มีชื่ออุปกรณ์นี้อยู่แล้ว</div>
    <% } else if (success === 'fk') { %>
      <div class="alert alert-warning">ลบไม่ได้: มีประวัติการยืมอ้างถึงอุปกรณ์นี้</div>
    <% } else if (success === 'toggled') { %>
      <div class="alert alert-success">เปลี่ยนสถานะเรียบร้อย</div>
    <% } else if (success === 'notfound') { %>
      <div class="alert alert-warning">ไม่พบรายการ</div>
    <% } else if (success === 'stock_underflow') { %>
      <div class="alert alert-warning">สต็อกติดลบไม่ได้</div>
    <% } else if (error) { %>
      <div class="alert alert-danger"><%= error %></div>
    <% } %>

    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:45%">ชื่ออุปกรณ์</th>
            <th class="text-center" style="width:10%">สต็อก</th>
            <th class="text-center" style="width:10%">สถานะ</th>
            <th class="text-end" style="width:35%">จัดการ</th>
          </tr>
        </thead>
        <tbody>
          <% if (!items || !items.length) { %>
            <tr><td colspan="4" class="text-center text-muted p-4">ยังไม่มีอุปกรณ์</td></tr>
          <% } else { %>
            <% items.forEach(function(it){ %>
              <tr>
                <td><%= it.item_name %></td>
                <td class="text-center"><strong><%= it.stock %></strong></td>
                <td class="text-center">
                  <% if (it.active) { %>
                    <span class="badge text-bg-success">ใช้งาน</span>
                  <% } else { %>
                    <span class="badge text-bg-secondary">ปิด</span>
                  <% } %>
                </td>
               <td class="text-end actions">
  <!-- ลดสต็อก -->
  <form class="d-inline" method="post" action="/staff/inventory/adjust">
    <input type="hidden" name="id" value="<%= it.id %>">
    <input type="hidden" name="delta" value="-1">
    <button type="submit" class="btn btn-sm btn-outline-secondary" <%= it.stock ? '' : 'disabled' %>>-1</button>
  </form>

  <!-- เพิ่มสต็อก -->
  <form class="d-inline" method="post" action="/staff/inventory/adjust">
    <input type="hidden" name="id" value="<%= it.id %>">
    <input type="hidden" name="delta" value="1">
    <button type="submit" class="btn btn-sm btn-outline-primary">+1</button>
  </form>

  <!-- เปิด/ปิดการใช้งาน -->
  <form class="d-inline" method="post" action="/staff/inventory/toggle/<%= it.id %>">
    <button type="submit" class="btn btn-sm <%= it.active ? 'btn-outline-warning' : 'btn-outline-success' %>">
      <%= it.active ? 'ปิดใช้งาน' : 'เปิดใช้งาน' %>
    </button>
  </form>

  <!-- ปุ่มแก้ไข (เปิด modal ด้านล่างไฟล์) -->
  <button type="button" class="btn btn-sm btn-outline-dark"
          data-bs-toggle="modal"
          data-bs-target="#edit-<%= it.id %>">แก้ไข</button>

  <!-- ลบ -->
  <form class="d-inline delete-form" method="post"
        action="/staff/inventory/<%= it.id %>/delete"
        data-name="<%= it.item_name %>">
    <button type="submit" class="btn btn-sm btn-outline-danger">ลบ</button>
  </form>
</td>
              </tr>
            <% }) %>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal แก้ไข -->
  <% if (items && items.length) { %>
    <% items.forEach(function(it){ %>
      <div class="modal fade" id="edit-<%= it.id %>" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <form method="post" action="/staff/inventory/<%= it.id %>/edit">
              <div class="modal-header">
                <h5 class="modal-title">แก้ไขอุปกรณ์</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">ชื่ออุปกรณ์</label>
                  <input type="text" name="name" class="form-control" required value="<%= it.item_name %>">
                </div>
                <div class="mb-3">
                  <label class="form-label">สต็อก</label>
                  <input type="number" name="stock" class="form-control" min="0" step="1" required value="<%= it.stock %>">
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="active-<%= it.id %>" name="active" <%= it.active ? 'checked' : '' %>>
                  <label class="form-check-label" for="active-<%= it.id %>">เปิดใช้งาน</label>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">ยกเลิก</button>
                <button class="btn btn-primary" type="submit">บันทึก</button>

              </div>
            </form>
          </div>
        </div>
      </div>
    <% }) %>
  <% } %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ยืนยันก่อนลบ (เลี่ยงปัญหา quote ซ้อนใน template)
    document.querySelectorAll('.delete-form').forEach(f=>{
      f.addEventListener('submit', (e)=>{
        const name = f.getAttribute('data-name') || 'รายการนี้';
        if(!confirm(`ยืนยันลบ "${name}" ?`)){
          e.preventDefault();
        }
      });
    });
  </script>
</body>
</html>
